import paramiko
import os
from dotenv import load_dotenv

# Cargar variables de entorno desde el archivo .env
load_dotenv()

# Acceder a las variables de entorno
os_ip = os.getenv('IP')
os_port = os.getenv('PORT')
os_password = os.getenv('PASSWORD')
os_username = os.getenv('USERNAME')

# Configuración de la conexión
hostname = os_ip  # IP de la otra computadora
port = os_port  # Puerto SSH por defecto
username = os_username  # Usuario en la otra computadora
password = os_password  # Contraseña del usuario

# Crear un cliente SSH
ssh = paramiko.SSHClient()
ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())

try:
    # Conectar al servidor remoto
    ssh.connect(hostname, port, username, password)

    # Crear un cliente SFTP
    sftp = ssh.open_sftp()

    # # Directorio remoto y local
    # local_path = '/Users/mgobea/Documents/Personal_Develop/ethical_hacking_python/ingreso_otra_ip/test_llevar.txt'
    # remote_path = '/mnt/c/Users/maria/Documents/developer-windows/ethical_hacking_python/test_llevar_local.txt'

    # # Descargar el archivo
    # sftp.get(remote_path, local_path)

    # print(f"Archivo descargado con éxito: {local_path}")

    # Ejecutar comando para listar el contenido de la carpeta Documents
    stdin, stdout, stderr = ssh.exec_command('ls -R /mnt/c/Users/maria/Documents/')
    tree_content = stdout.read().decode()

    # Ruta del archivo local para guardar el árbol de directorios
    tree_file_path = '/mnt/c/Users/maria/Documents/developer-windows/ethical_hacking_python/documents_tree.txt'

    # Guardar el árbol de directorios en un archivo local
    with open(tree_file_path, 'w') as tree_file:
        tree_file.write(tree_content)

    print(f"Árbol de directorios guardado con éxito: {tree_file_path}")

    # Cerrar la conexión SFTP
    sftp.close()
    
except Exception as e:
    print(f"Error: {e}")
finally:
    # Cerrar la conexión SSH
    ssh.close()
