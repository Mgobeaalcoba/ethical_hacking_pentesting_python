import requests
import pandas as pd
import argparse
from bs4 import BeautifulSoup

parser = argparse.ArgumentParser(description="Detector de Cabeceras o Headers")
parser.add_argument('-t', '--target', help="Objetivo") # Le agrego opciones a mi programa por consola. target será la variable que contenga mi objetivo
parser = parser.parse_args()

def main():
    """
    Tomando un dominio "x" este script explora que otros dominios están inscriptos en la misma IP usando el servicio de viewdns.info mediante web scrapping
    y luego exporta un excel con esta información. En este script el dominio a scrapear se ingresa por terminal usando argparse
    """

    if parser.target is None:
        sitio = 'www.lanacion.com'
    else:
        sitio = parser.target
    
    name_file = sitio.split('.')[1]
    agent = {
        "User-Agent": "Firefox"
    }

    viewdns = f'https://viewdns.info/reverseip/?host={sitio}&t=1'
    request = requests.get(viewdns, headers=agent)
    soup = BeautifulSoup(request.text, 'html5lib')
    soup_tables = soup.findAll('table')

    # Filtrar la tabla con el atributo border="1"
    table_with_border = None
    for table in soup_tables:
        if table.get('border') == '1':
            table_with_border = table
            break

    # Verificar si la tabla se encontró
    if table_with_border:
        tr_items = []
        print("Tabla encontrada:")
        # print(table_with_border)
        trs = table_with_border.findAll('tr')
        for tr in trs:
            tds = tr.findAll('td')
            tds_list = []
            for td in tds:
                tds_list.append(td.text)
            tr_items.append(tds_list)
        df = pd.DataFrame(tr_items[1:], columns=tr_items[0])
        df.to_excel(f"dominios_{name_file}.xlsx", sheet_name="dominios_registrados", index=False)
        print("Excel cargado!!!")
        print(df.info())

    else:
        print("No se encontró una tabla con border=\"1\"")

if __name__ == '__main__':
    try:
        main()
    except KeyboardInterrupt:
        print("Saliendo...")
        exit()

